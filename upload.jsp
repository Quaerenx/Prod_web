<%@ page contentType="text/html; charset=UTF-8" %>
<%@ page import="java.io.*" %>
<%@ page import="java.util.*" %>
<%
    // ÏÑ∏ÏÖò ÌôïÏù∏
    HttpSession userSession = request.getSession(false);
    if (userSession == null || userSession.getAttribute("user") == null) {
        response.sendRedirect("login");
        return;
    }
%>

<%
    String relativePath = request.getParameter("path");
    if (relativePath == null) relativePath = "";

    // Î≥¥Ïïà Í≤ÄÏ¶ù
    if (relativePath.contains("..") || relativePath.contains("\\")) {
        out.println("<h3>ÏûòÎ™ªÎêú Í≤ΩÎ°úÏûÖÎãàÎã§.</h3>");
        return;
    }
    
    String baseDir = "/files";
    String realPath = application.getRealPath(baseDir + "/" + relativePath);
    File currentDir = new File(realPath);
    if (!currentDir.exists() || !currentDir.isDirectory()) {
        out.println("<h3>ÏûòÎ™ªÎêú Í≤ΩÎ°úÏûÖÎãàÎã§.</h3>");
        return;
    }
%>

<% 
    // ÌéòÏù¥ÏßÄ ÌÉÄÏù¥ÌãÄ ÏÑ§Ï†ï
    pageContext.setAttribute("pageTitle", "ÌååÏùº ÏóÖÎ°úÎìú");
%>

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ÌååÏùº ÏóÖÎ°úÎìú - <%= relativePath.isEmpty() ? "/" : ("/" + relativePath) %></title>
    <style>
        /* Î™®Îì† Ïä§ÌÉÄÏùºÏùÑ Ïù∏ÎùºÏù∏ÏúºÎ°ú Ìè¨Ìï® */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        
        .container {
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        
        .upload-main {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 30px;
        }
        
        .back-link {
            display: inline-flex;
            align-items: center;
            color: #6c757d;
            text-decoration: none;
            font-size: 14px;
            margin-bottom: 20px;
            padding: 8px 16px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .back-link:hover {
            color: #007bff;
            text-decoration: none;
            background-color: #f8f9fa;
        }
        
        .breadcrumb {
            background: #f8f9fa;
            padding: 15px 20px;
            border-radius: 6px;
            margin-bottom: 30px;
            font-size: 14px;
            border: 1px solid #dee2e6;
        }
        
        .breadcrumb a {
            color: #495057;
            text-decoration: none;
        }
        
        .breadcrumb a:hover {
            color: #007bff;
            text-decoration: underline;
        }
        
        h2 {
            color: #495057;
            margin-bottom: 10px;
        }
        
        .text-muted {
            color: #6c757d;
            margin-bottom: 20px;
        }
        
        .upload-info {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 30px;
        }
        
        .upload-info h6 {
            color: #0056b3;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .upload-info ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .upload-info li {
            color: #495057;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .upload-form {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 8px;
            border: 2px dashed #dee2e6;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }
        
        .upload-form:hover {
            border-color: #007bff;
            background: #e3f2fd;
        }
        
        .upload-form.dragover {
            border-color: #007bff;
            background: #e3f2fd;
            transform: scale(1.02);
        }
        
        .file-input {
            margin: 20px 0;
        }
        
        .file-input input[type="file"] {
            display: none;
        }
        
        .file-input label {
            display: inline-block;
            padding: 12px 24px;
            background: #007bff;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s ease;
        }
        
        .file-input label:hover {
            background: #0056b3;
        }
        
        .selected-files {
            margin-top: 20px;
            text-align: left;
        }
        
        .selected-files h5 {
            margin-bottom: 15px;
            color: #495057;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .file-info {
            display: flex;
            align-items: center;
        }
        
        .file-icon {
            margin-right: 10px;
            font-size: 20px;
        }
        
        .file-details {
            flex: 1;
        }
        
        .file-name {
            font-weight: 500;
            color: #495057;
        }
        
        .file-size {
            font-size: 12px;
            color: #6c757d;
        }
        
        .remove-file {
            color: #dc3545;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background 0.3s ease;
        }
        
        .remove-file:hover {
            background: #f8d7da;
        }
        
        .upload-controls {
            margin-top: 30px;
            text-align: center;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 500;
            text-align: center;
            text-decoration: none;
            border: 1px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            margin: 0 5px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background-color: #0056b3;
            border-color: #0056b3;
        }
        
        .btn-primary:disabled {
            background-color: #6c757d;
            border-color: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #545b62;
            border-color: #545b62;
        }
        
        .progress-container {
            display: none;
            margin-top: 20px;
        }
        
        .progress {
            height: 25px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #dee2e6;
        }
        
        .progress-bar {
            height: 100%;
            background-color: #007bff;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 500;
            font-size: 14px;
        }
        
        .upload-status {
            display: none;
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
        }
        
        .upload-status.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .upload-status.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .text-center {
            text-align: center;
        }
        
        .mt-2 {
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <!-- Header Include -->
    <%@ include file="includes/header.jsp" %>

    <div class="container">
        <div class="upload-main">
            <!-- Îí§Î°úÍ∞ÄÍ∏∞ ÎßÅÌÅ¨ -->
            <a href="downlist.jsp?path=<%= relativePath %>" class="back-link">
                ‚¨ÖÔ∏è ÌååÏùº Î™©Î°ùÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞
            </a>

            <!-- ÌòÑÏû¨ Í≤ΩÎ°ú ÌëúÏãú -->
            <div class="breadcrumb">
                <strong>üì§ ÏóÖÎ°úÎìú ÏúÑÏπò:</strong> 
                <a href="downlist.jsp">/</a><%
                if (!relativePath.isEmpty()) {
                    String[] parts = relativePath.split("/");
                    String currentPath = "";
                    for (int i = 0; i < parts.length; i++) {
                        if (!parts[i].isEmpty()) {
                            currentPath += parts[i];
                            out.print("<a href=\"downlist.jsp?path=" + currentPath + "\">" + parts[i] + "</a>");
                            if (i < parts.length - 1) out.print("/");
                            currentPath += "/";
                        }
                    }
                }
                %>
            </div>

            <h2>üì§ ÌååÏùº ÏóÖÎ°úÎìú</h2>
            <p class="text-muted">ÏóÖÎ°úÎìúÌï† ÌååÏùºÏùÑ ÏÑ†ÌÉùÌïòÍ±∞ÎÇò ÎìúÎûòÍ∑∏ÌïòÏó¨ ÎÜìÏúºÏÑ∏Ïöî.</p>

            <!-- ÏóÖÎ°úÎìú Ï†ïÎ≥¥ -->
            <div class="upload-info">
                <h6>üìã ÏóÖÎ°úÎìú ÏïàÎÇ¥ÏÇ¨Ìï≠</h6>
                <ul>
                    <li>ÏµúÎåÄ ÌååÏùº ÌÅ¨Í∏∞: <strong>10MB</strong></li>
                    <li>ÌóàÏö©ÎêòÏßÄ ÏïäÎäî ÌååÏùº: .exe, .jsp, .php, .bat, .cmd, .scr</li>
                    <li>ÎèôÏùºÌïú Ïù¥Î¶ÑÏùò ÌååÏùºÏù¥ ÏûàÏúºÎ©¥ ÏûêÎèôÏúºÎ°ú Î≤àÌò∏Í∞Ä Ï∂îÍ∞ÄÎê©ÎãàÎã§</li>
                    <li>Ïó¨Îü¨ ÌååÏùºÏùÑ ÎèôÏãúÏóê ÏÑ†ÌÉùÌï† Ïàò ÏûàÏäµÎãàÎã§</li>
                </ul>
            </div>

            <!-- ÏóÖÎ°úÎìú Ìèº -->
            <form id="uploadForm">
                <input type="hidden" name="path" value="<%= relativePath %>">
                
                <div class="upload-form" id="uploadArea">
                    <div style="font-size: 48px; color: #007bff; margin-bottom: 20px;">üìÅ</div>
                    <h4>ÌååÏùºÏùÑ Ïó¨Í∏∞Ïóê ÎìúÎûòÍ∑∏ÌïòÍ±∞ÎÇò</h4>
                    <div class="file-input">
                        <label for="fileInput">
                            ÌååÏùº ÏÑ†ÌÉùÌïòÍ∏∞
                        </label>
                        <input type="file" id="fileInput" name="uploadFiles" multiple accept="*/*">
                    </div>
                    <p class="text-muted">Ïó¨Îü¨ ÌååÏùºÏùÑ ÎèôÏãúÏóê ÏÑ†ÌÉùÌï† Ïàò ÏûàÏäµÎãàÎã§</p>
                </div>

                <!-- ÏÑ†ÌÉùÎêú ÌååÏùº Î™©Î°ù -->
                <div id="selectedFiles" class="selected-files" style="display: none;">
                    <h5>ÏÑ†ÌÉùÎêú ÌååÏùº Î™©Î°ù</h5>
                    <div id="fileList"></div>
                </div>

                <!-- ÏßÑÌñâÎ•† ÌëúÏãú -->
                <div class="progress-container" id="progressContainer">
                    <div class="progress">
                        <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%">0%</div>
                    </div>
                    <p class="text-center mt-2" id="progressText">ÏóÖÎ°úÎìú Ï§ÄÎπÑ Ï§ë...</p>
                </div>

                <!-- ÏóÖÎ°úÎìú ÏÉÅÌÉú Î©îÏãúÏßÄ -->
                <div id="uploadStatus" class="upload-status"></div>

                <!-- ÏóÖÎ°úÎìú Î≤ÑÌäº -->
                <div class="upload-controls">
                    <button type="submit" class="btn btn-primary" id="uploadBtn" disabled>
                        üì§ ÏóÖÎ°úÎìú ÏãúÏûë
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="clearFiles()">
                        üóëÔ∏è ÏÑ†ÌÉù Ï∑®ÏÜå
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Footer Include -->
    <%@ include file="includes/footer.jsp" %>

    <script>
        // Ï†ÑÏó≠ Î≥ÄÏàò
        let selectedFiles = [];
        const maxFileSize = 10 * 1024 * 1024; // 10MB
        const forbiddenExtensions = ['.exe', '.jsp', '.php', '.bat', '.cmd', '.scr'];

        // ÌéòÏù¥ÏßÄ Î°úÎìú ÏôÑÎ£å ÌõÑ Ïã§Ìñâ
        window.addEventListener('load', function() {
            console.log('ÌéòÏù¥ÏßÄ Î°úÎìú ÏôÑÎ£å');
            initializeFileUpload();
        });

        function initializeFileUpload() {
            console.log('ÌååÏùº ÏóÖÎ°úÎìú Ï¥àÍ∏∞Ìôî ÏãúÏûë');
            
            // ÌååÏùº ÏÑ†ÌÉù Ïù¥Î≤§Ìä∏
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    console.log('ÌååÏùº ÏÑ†ÌÉùÎê®:', e.target.files.length, 'Í∞ú');
                    handleFiles(e.target.files);
                });
                console.log('‚úì ÌååÏùº input Ïù¥Î≤§Ìä∏ Îì±Î°ùÎê®');
            } else {
                console.error('‚ùå fileInput ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§!');
                return;
            }

            // ÎìúÎûòÍ∑∏ Ïï§ ÎìúÎ°≠ Ïù¥Î≤§Ìä∏
            const uploadArea = document.getElementById('uploadArea');
            if (uploadArea) {
                uploadArea.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });

                uploadArea.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                });

                uploadArea.addEventListener('drop', function(e) {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    console.log('ÌååÏùº ÎìúÎ°≠Îê®:', e.dataTransfer.files.length, 'Í∞ú');
                    handleFiles(e.dataTransfer.files);
                });
                console.log('‚úì ÎìúÎûòÍ∑∏Ïï§ÎìúÎ°≠ Ïù¥Î≤§Ìä∏ Îì±Î°ùÎê®');
            } else {
                console.error('‚ùå uploadArea ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§!');
            }

            // Ìèº Ï†úÏ∂ú Ïù¥Î≤§Ìä∏
            const uploadForm = document.getElementById('uploadForm');
            if (uploadForm) {
                uploadForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    console.log('Ìèº Ï†úÏ∂úÎê®, ÏÑ†ÌÉùÎêú ÌååÏùº Ïàò:', selectedFiles.length);
                    handleFormSubmit();
                });
                console.log('‚úì Ìèº Ïù¥Î≤§Ìä∏ Îì±Î°ùÎê®');
            } else {
                console.error('‚ùå uploadForm ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§!');
            }
            
            console.log('ÌååÏùº ÏóÖÎ°úÎìú Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
        }

        function handleFiles(files) {
            console.log('=== handleFiles ÏãúÏûë ===');
            console.log('Î∞õÏùÄ ÌååÏùº Ïàò:', files.length);
            
            if (!files || files.length === 0) {
                console.log('ÏÑ†ÌÉùÎêú ÌååÏùºÏù¥ ÏóÜÏäµÎãàÎã§');
                return;
            }
            
            const fileArray = Array.from(files);
            
            fileArray.forEach((file, index) => {
                console.log('ÌååÏùº ' + (index + 1) + ': ' + file.name + ' (' + file.size + ' bytes)');
                
                // ÌååÏùº ÌÅ¨Í∏∞ Í≤ÄÏ¶ù
                if (file.size > maxFileSize) {
                    console.warn('ÌååÏùº ÌÅ¨Í∏∞ Ï¥àÍ≥º: ' + file.name);
                    showMessage('ÌååÏùº "' + file.name + '"Ïù¥ ÎÑàÎ¨¥ ÌÅΩÎãàÎã§. (ÏµúÎåÄ 10MB)', 'error');
                    return;
                }

                // ÌååÏùº ÌôïÏû•Ïûê Í≤ÄÏ¶ù
                const fileName = file.name.toLowerCase();
                const isForbidden = forbiddenExtensions.some(ext => fileName.endsWith(ext));
                if (isForbidden) {
                    console.warn('Í∏àÏßÄÎêú ÌôïÏû•Ïûê: ' + file.name);
                    showMessage('ÌååÏùº "' + file.name + '"ÏùÄ Î≥¥ÏïàÏÉÅ ÏóÖÎ°úÎìúÌï† Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
                    return;
                }

                // Ï§ëÎ≥µ ÌååÏùº Í≤ÄÏÇ¨
                const isDuplicate = selectedFiles.some(f => f.name === file.name && f.size === file.size);
                if (!isDuplicate) {
                    selectedFiles.push(file);
                    console.log('‚úì ÌååÏùº Ï∂îÍ∞Ä: ' + file.name);
                } else {
                    console.log('Ï§ëÎ≥µ ÌååÏùº Î¨¥Ïãú: ' + file.name);
                }
            });

            console.log('ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÌååÏùº Ï¥ù Í∞úÏàò:', selectedFiles.length);
            updateFileList();
            updateUploadButton();
            console.log('=== handleFiles ÏôÑÎ£å ===');
        }

        function updateFileList() {
            console.log('=== updateFileList ÏãúÏûë ===');
            
            const fileList = document.getElementById('fileList');
            const selectedFilesDiv = document.getElementById('selectedFiles');

            if (!fileList || !selectedFilesDiv) {
                console.error('‚ùå ÌïÑÏöîÌïú DOM ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§!');
                return;
            }

            if (selectedFiles.length === 0) {
                selectedFilesDiv.style.display = 'none';
                console.log('ÌååÏùºÏù¥ ÏóÜÏñ¥ÏÑú Î™©Î°ù Ïà®ÍπÄ');
                return;
            }

            selectedFilesDiv.style.display = 'block';
            fileList.innerHTML = '';
            console.log('‚úì ÌååÏùº Î™©Î°ù Ïª®ÌÖåÏù¥ÎÑà ÌëúÏãú');

            selectedFiles.forEach(function(file, index) {
                console.log('ÌååÏùº ' + index + ' UI ÏÉùÏÑ±: ' + file.name);
                
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                
                const fileIcon = getFileIcon(file.name);
                const fileSize = formatFileSize(file.size);
                const escapedFileName = escapeHtml(file.name);

                // EL Ï∂©ÎèåÏùÑ ÌîºÌïòÍ∏∞ ÏúÑÌï¥ Î¨∏ÏûêÏó¥ Ïó∞Í≤∞ ÏÇ¨Ïö©
                fileItem.innerHTML = '<div class="file-info">' +
                    '<div class="file-icon">' + fileIcon + '</div>' +
                    '<div class="file-details">' +
                        '<div class="file-name">' + escapedFileName + '</div>' +
                        '<div class="file-size">' + fileSize + '</div>' +
                    '</div>' +
                '</div>' +
                '<div class="remove-file" onclick="removeFile(' + index + ')">' +
                    'üóëÔ∏è' +
                '</div>';

                fileList.appendChild(fileItem);
            });
            
            console.log('‚úì ÌååÏùº Î™©Î°ù UI ÏÉùÏÑ± ÏôÑÎ£å');
            console.log('=== updateFileList ÏôÑÎ£å ===');
        }

        function removeFile(index) {
            console.log('ÌååÏùº Ï†úÍ±∞:', selectedFiles[index] ? selectedFiles[index].name : 'undefined');
            selectedFiles.splice(index, 1);
            updateFileList();
            updateUploadButton();
        }

        function clearFiles() {
            console.log('Î™®Îì† ÌååÏùº Ï†úÍ±∞');
            selectedFiles = [];
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.value = '';
            }
            updateFileList();
            updateUploadButton();
            hideMessage();
            hideProgress();
        }

        function updateUploadButton() {
            const uploadBtn = document.getElementById('uploadBtn');
            if (uploadBtn) {
                uploadBtn.disabled = selectedFiles.length === 0;
                console.log('ÏóÖÎ°úÎìú Î≤ÑÌäº:', uploadBtn.disabled ? 'ÎπÑÌôúÏÑ±Ìôî' : 'ÌôúÏÑ±Ìôî');
            }
        }

        function getFileIcon(filename) {
            const ext = filename.toLowerCase().split('.').pop();
            
            if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg'].includes(ext)) return 'üñºÔ∏è';
            if (['mp4', 'avi', 'mov', 'wmv', 'flv', 'mkv'].includes(ext)) return 'üé¨';
            if (['mp3', 'wav', 'flac', 'aac', 'ogg'].includes(ext)) return 'üéµ';
            if (ext === 'pdf') return 'üìã';
            if (['doc', 'docx'].includes(ext)) return 'üìù';
            if (['xls', 'xlsx'].includes(ext)) return 'üìä';
            if (['zip', 'rar', '7z', 'tar', 'gz'].includes(ext)) return 'üì¶';
            if (['txt', 'log'].includes(ext)) return 'üìÉ';
            
            return 'üìÑ';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            
            const units = ['B', 'KB', 'MB', 'GB'];
            const k = 1024;
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + units[i];
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showProgress() {
            const progressContainer = document.getElementById('progressContainer');
            if (progressContainer) {
                progressContainer.style.display = 'block';
            }
        }

        function hideProgress() {
            const progressContainer = document.getElementById('progressContainer');
            if (progressContainer) {
                progressContainer.style.display = 'none';
                updateProgress(0, 'ÏóÖÎ°úÎìú Ï§ÄÎπÑ Ï§ë...');
            }
        }

        function updateProgress(percent, text) {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            if (progressBar) {
                progressBar.style.width = percent + '%';
                progressBar.textContent = Math.round(percent) + '%';
            }
            
            if (progressText) {
                progressText.textContent = text || 'ÏóÖÎ°úÎìú Ï§ë...';
            }
        }

        function showMessage(message, type) {
            const statusDiv = document.getElementById('uploadStatus');
            if (statusDiv) {
                statusDiv.textContent = message;
                statusDiv.className = 'upload-status ' + type;
                statusDiv.style.display = 'block';
                
                if (type === 'success') {
                    setTimeout(function() {
                        hideMessage();
                    }, 5000);
                }
            }
            
            console.log('Î©îÏãúÏßÄ [' + type + ']: ' + message);
        }

        function hideMessage() {
            const statusDiv = document.getElementById('uploadStatus');
            if (statusDiv) {
                statusDiv.style.display = 'none';
                statusDiv.className = 'upload-status';
            }
        }

        function handleFormSubmit() {
            if (selectedFiles.length === 0) {
                showMessage('ÏóÖÎ°úÎìúÌï† ÌååÏùºÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.', 'error');
                return;
            }

            const formData = new FormData();
            
            const pathInput = document.querySelector('input[name="path"]');
            if (pathInput) {
                formData.append('path', pathInput.value);
            }
            
            selectedFiles.forEach(function(file) {
                formData.append('uploadFiles', file);
            });

            console.log('FormData ÏÉùÏÑ± ÏôÑÎ£å, ÌååÏùº Ïàò:', selectedFiles.length);

            showProgress();
            updateProgress(0, 'ÏóÖÎ°úÎìú ÏãúÏûë Ï§ë...');
            
            const uploadBtn = document.getElementById('uploadBtn');
            if (uploadBtn) {
                uploadBtn.disabled = true;
            }
            
            hideMessage();

            const xhr = new XMLHttpRequest();
            
            xhr.upload.addEventListener('progress', function(e) {
                if (e.lengthComputable) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    updateProgress(percentComplete, 'ÏóÖÎ°úÎìú Ï§ë... (' + selectedFiles.length + 'Í∞ú ÌååÏùº)');
                }
            });

            xhr.addEventListener('load', function() {
                console.log('ÏóÖÎ°úÎìú ÏùëÎãµ ÏÉÅÌÉú:', xhr.status);
                
                if (xhr.status === 200) {
                    updateProgress(100, 'ÏóÖÎ°úÎìú ÏôÑÎ£å!');
                    showMessage('ÌååÏùº ÏóÖÎ°úÎìúÍ∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§! Ïû†Ïãú ÌõÑ ÌååÏùº Î™©Î°ùÏúºÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§.', 'success');
                    
                    setTimeout(function() {
                        const pathInput = document.querySelector('input[name="path"]');
                        const pathParam = pathInput && pathInput.value ? '?path=' + pathInput.value : '';
                        window.location.href = 'downlist.jsp' + pathParam;
                    }, 3000);
                    
                } else {
                    hideProgress();
                    showMessage('ÏóÖÎ°úÎìú Ï§ë ÏÑúÎ≤Ñ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. (ÏÉÅÌÉú ÏΩîÎìú: ' + xhr.status + ')', 'error');
                    if (uploadBtn) {
                        uploadBtn.disabled = false;
                    }
                }
            });

            xhr.addEventListener('error', function() {
                console.error('ÏóÖÎ°úÎìú ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò');
                hideProgress();
                showMessage('ÏóÖÎ°úÎìú Ï§ë ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
                if (uploadBtn) {
                    uploadBtn.disabled = false;
                }
            });

            xhr.addEventListener('timeout', function() {
                console.error('ÏóÖÎ°úÎìú ÌÉÄÏûÑÏïÑÏõÉ');
                hideProgress();
                showMessage('ÏóÖÎ°úÎìú ÏãúÍ∞ÑÏù¥ Ï¥àÍ≥ºÎêòÏóàÏäµÎãàÎã§. ÌååÏùº ÌÅ¨Í∏∞Î•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                if (uploadBtn) {
                    uploadBtn.disabled = false;
                }
            });

            xhr.open('POST', 'uploadProcess.jsp', true);
            xhr.timeout = 300000;
            xhr.send(formData);
            
            console.log('AJAX ÏóÖÎ°úÎìú ÏãúÏûë');
        }
    </script>
</body>
</html>